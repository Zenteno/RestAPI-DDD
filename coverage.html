
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>corner_azenteno: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">corner_azenteno/app.go (80.0%)</option>
				
				<option value="file1">corner_azenteno/controller/session-controller.go (90.9%)</option>
				
				<option value="file2">corner_azenteno/docs/docs.go (8.3%)</option>
				
				<option value="file3">corner_azenteno/repository/mem-repo.go (90.9%)</option>
				
				<option value="file4">corner_azenteno/repository/mongo-repo.go (0.0%)</option>
				
				<option value="file5">corner_azenteno/service/session-service.go (100.0%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package main

import (
        "corner_azenteno/controller"
        _ "corner_azenteno/docs"
        "corner_azenteno/repository"
        "corner_azenteno/service"
        "flag"
        "log"
        "os"

        swagger "github.com/arsmn/fiber-swagger/v2"
        "github.com/gofiber/fiber/v2"
        "github.com/gofiber/fiber/v2/middleware/logger"
        "github.com/gofiber/fiber/v2/middleware/recover"
)

var (
        port              = flag.String("port", "3000", "Port to listen on")
        prod              = flag.Bool("prod", false, "Enable prefork in Production")
        sessionController controller.SessionController
        sessionService    service.SessionService
)

// @title Corner API
// @version 1.0
// @description This is a sample service for managing cornershop sessions.
// @termsOfService http://swagger.io/terms/
// @contact.name Alberto Zenteno
// @contact.email x.zenteno.a@gmail.com
// @license.name Apache 2.0
// @license.url http://www.apache.org/licenses/LICENSE-2.0.html
func main() <span class="cov0" title="0">{

        app := Setup(repository.NewMongoRepository(os.Getenv("MONGO_HOST"), 27017, "cornershop", 10))
        flag.Parse()
        log.Fatal(app.Listen(":" + *port))
}</span>

func Setup(repository repository.SessionRepository) *fiber.App <span class="cov8" title="1">{
        sessionService = service.NewSessionService(repository)
        sessionController = controller.NewSessionController(sessionService)
        app := fiber.New(fiber.Config{
                Prefork: *prod,
        })

        app.Use(recover.New())
        app.Use(logger.New())

        v1 := app.Group("/api/v1")

        v1.Get("/current_shopper_location/:shopper_uuid", sessionController.CurrentLocation)
        v1.Get("/session_location_history/:session_uuid", sessionController.HistorySession)
        v1.Post("/location", sessionController.AddLocation)

        app.Use("/docs", swagger.Handler)
        app.Use(sessionController.NotFound)
        return app
}</span>
</pre>
		
		<pre class="file" id="file1" style="display: none">package controller

import (
        "corner_azenteno/entity"
        "corner_azenteno/repository"
        "corner_azenteno/service"
        "fmt"

        "github.com/gofiber/fiber/v2"
)

type SessionController interface {
        HistorySession(c *fiber.Ctx) error
        CurrentLocation(c *fiber.Ctx) error
        AddLocation(c *fiber.Ctx) error
        NotFound(c *fiber.Ctx) error
}

type sessionController struct{}

var sessionService service.SessionService

func NewSessionController(service service.SessionService) SessionController <span class="cov8" title="1">{
        sessionService = service
        return &amp;sessionController{}
}</span>

// GetHistorySessions godoc
// @Summary Get location history of a session
// @Description Get location history of a session
// @Tags History Session
// @Param session_uuid path string true "Session UUID"
// @Produce  json
// @Success 200 {array} entity.ShopperHistory
// @Router /api/v1/session_location_history/{session_uuid} [get]
func (*sessionController) HistorySession(c *fiber.Ctx) error <span class="cov8" title="1">{
        sessionUUID := c.Params("session_uuid")
        data, err := sessionService.GetSessionHistory(sessionUUID)
        if err != nil </span><span class="cov8" title="1">{
                if err == repository.NotFoundErr </span><span class="cov8" title="1">{
                        c.SendStatus(404)
                }</span> else<span class="cov0" title="0"> {
                        c.SendStatus(400)
                }</span>
                <span class="cov8" title="1">return nil</span>
        }
        <span class="cov8" title="1">return c.JSON(data)</span>
}

// GetCurrentLocation godoc
// @Summary Get current position of a shopper
// @Description Get current position of a shopper
// @Tags Shopper Position
// @Param shopper_uuid path string true "Shopper UUID"
// @Produce  json
// @Success 200 {object} entity.ShopperHistory
// @Router /api/v1/current_shopper_location/{shopper_uuid} [get]
func (*sessionController) CurrentLocation(c *fiber.Ctx) error <span class="cov8" title="1">{
        shopperUUID := c.Params("shopper_uuid")
        data, err := sessionService.GetShopperLocation(shopperUUID)

        if err != nil </span><span class="cov8" title="1">{
                if err == repository.NotFoundErr </span><span class="cov8" title="1">{
                        c.SendStatus(404)
                }</span> else<span class="cov0" title="0"> {
                        c.SendStatus(400)
                }</span>
                <span class="cov8" title="1">return nil</span>

        }
        <span class="cov8" title="1">return c.JSON(data)</span>
}

// AddLocation godoc
// @Summary Insert location data
// @Description Insert location data
// @Param account body entity.ShopperHistory true "Add Location"
// @Tags Insert Location
// @Accept json
// @Produce  json
// @Success 200
// @Router /api/v1/location [post]
func (*sessionController) AddLocation(c *fiber.Ctx) error <span class="cov8" title="1">{
        history := new(entity.ShopperHistory)
        if err := c.BodyParser(history); err != nil </span><span class="cov8" title="1">{
                fmt.Println(err)
                c.SendStatus(400)
                return nil
        }</span>

        <span class="cov8" title="1">err := sessionService.Validate(history)
        if err != nil </span><span class="cov8" title="1">{
                fmt.Println(err)
                c.Status(400).JSON(fiber.Map{
                        "message": "missing parameters",
                })
                return nil
        }</span>
        <span class="cov8" title="1">err = sessionService.Insert(history)
        if err == nil </span><span class="cov8" title="1">{
                return c.SendStatus(201)
        }</span>
        <span class="cov0" title="0">return c.SendStatus(400)</span>
}

func (*sessionController) NotFound(c *fiber.Ctx) error <span class="cov8" title="1">{
        return c.SendStatus(404)
}</span>
</pre>
		
		<pre class="file" id="file2" style="display: none">// GENERATED BY THE COMMAND ABOVE; DO NOT EDIT
// This file was generated by swaggo/swag

package docs

import (
        "bytes"
        "encoding/json"
        "strings"

        "github.com/alecthomas/template"
        "github.com/swaggo/swag"
)

var doc = `{
    "schemes": {{ marshal .Schemes }},
    "swagger": "2.0",
    "info": {
        "description": "{{.Description}}",
        "title": "{{.Title}}",
        "termsOfService": "http://swagger.io/terms/",
        "contact": {
            "name": "Alberto Zenteno",
            "email": "x.zenteno.a@gmail.com"
        },
        "license": {
            "name": "Apache 2.0",
            "url": "http://www.apache.org/licenses/LICENSE-2.0.html"
        },
        "version": "{{.Version}}"
    },
    "host": "{{.Host}}",
    "basePath": "{{.BasePath}}",
    "paths": {
        "/api/v1/current_shopper_location/{shopper_uuid}": {
            "get": {
                "description": "Get current position of a shopper",
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Shopper Position"
                ],
                "summary": "Get current position of a shopper",
                "parameters": [
                    {
                        "type": "string",
                        "description": "Shopper UUID",
                        "name": "shopper_uuid",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "$ref": "#/definitions/entity.ShopperHistory"
                        }
                    }
                }
            }
        },
        "/api/v1/location": {
            "post": {
                "description": "Insert location data",
                "consumes": [
                    "application/json"
                ],
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "Insert Location"
                ],
                "summary": "Insert location data",
                "parameters": [
                    {
                        "description": "Add Location",
                        "name": "account",
                        "in": "body",
                        "required": true,
                        "schema": {
                            "$ref": "#/definitions/entity.ShopperHistory"
                        }
                    }
                ],
                "responses": {
                    "200": {}
                }
            }
        },
        "/api/v1/session_location_history/{session_uuid}": {
            "get": {
                "description": "Get location history of a session",
                "produces": [
                    "application/json"
                ],
                "tags": [
                    "History Session"
                ],
                "summary": "Get location history of a session",
                "parameters": [
                    {
                        "type": "string",
                        "description": "Session UUID",
                        "name": "session_uuid",
                        "in": "path",
                        "required": true
                    }
                ],
                "responses": {
                    "200": {
                        "description": "OK",
                        "schema": {
                            "type": "array",
                            "items": {
                                "$ref": "#/definitions/entity.ShopperHistory"
                            }
                        }
                    }
                }
            }
        }
    },
    "definitions": {
        "entity.ShopperHistory": {
            "type": "object",
            "required": [
                "lat",
                "lng",
                "precision",
                "reported_at",
                "session_uuid",
                "shopper_uuid"
            ],
            "properties": {
                "lat": {
                    "type": "number"
                },
                "lng": {
                    "type": "number"
                },
                "precision": {
                    "type": "number"
                },
                "reported_at": {
                    "type": "string"
                },
                "session_uuid": {
                    "type": "string"
                },
                "shopper_uuid": {
                    "type": "string"
                }
            }
        }
    }
}`

type swaggerInfo struct {
        Version     string
        Host        string
        BasePath    string
        Schemes     []string
        Title       string
        Description string
}

// SwaggerInfo holds exported Swagger Info so clients can modify it
var SwaggerInfo = swaggerInfo{
        Version:     "1.0",
        Host:        "",
        BasePath:    "",
        Schemes:     []string{},
        Title:       "Corner API",
        Description: "This is a sample service for managing cornershop sessions.",
}

type s struct{}

func (s *s) ReadDoc() string <span class="cov0" title="0">{
        sInfo := SwaggerInfo
        sInfo.Description = strings.Replace(sInfo.Description, "\n", "\\n", -1)

        t, err := template.New("swagger_info").Funcs(template.FuncMap{
                "marshal": func(v interface{}) string </span><span class="cov0" title="0">{
                        a, _ := json.Marshal(v)
                        return string(a)
                }</span>,
        }).Parse(doc)
        <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                return doc
        }</span>

        <span class="cov0" title="0">var tpl bytes.Buffer
        if err := t.Execute(&amp;tpl, sInfo); err != nil </span><span class="cov0" title="0">{
                return doc
        }</span>

        <span class="cov0" title="0">return tpl.String()</span>
}

func init() <span class="cov8" title="1">{
        swag.Register(swag.Name, &amp;s{})
}</span>
</pre>
		
		<pre class="file" id="file3" style="display: none">package repository

import (
        "corner_azenteno/entity"
        "time"

        . "github.com/ahmetb/go-linq/v3"
)

type repo struct {
        history []*entity.ShopperHistory
}

func NewMemRepository() SessionRepository <span class="cov8" title="1">{
        return &amp;repo{
                history: []*entity.ShopperHistory{},
        }
}</span>

func (r *repo) GetSessionHistory(sessionUUIDVal string) ([]*entity.ShopperHistory, error) <span class="cov8" title="1">{
        if len(r.history) == 0 </span><span class="cov0" title="0">{
                return nil, NotFoundErr
        }</span>
        <span class="cov8" title="1">var result []*entity.ShopperHistory
        From(r.history).WhereT(func(i *entity.ShopperHistory) bool </span><span class="cov8" title="1">{
                return i.SessionUuid == sessionUUIDVal
        }</span>).OrderByDescendingT(
                func(i *entity.ShopperHistory) int64 <span class="cov8" title="1">{ return i.ReportedAt.Unix() }</span>,
        ).ToSlice(&amp;result)
        <span class="cov8" title="1">if len(result) == 0 </span><span class="cov8" title="1">{
                return nil, NotFoundErr
        }</span>
        <span class="cov8" title="1">return result, nil</span>
}

func (r *repo) GetShopperLocation(shoperUUIDVal string) (*entity.ShopperHistory, error) <span class="cov8" title="1">{
        if len(r.history) == 0 </span><span class="cov0" title="0">{
                return nil, NotFoundErr
        }</span>
        <span class="cov8" title="1">now := time.Now()
        then := now.Add(-10 * time.Minute)
        result := From(r.history).WhereT(func(i *entity.ShopperHistory) bool </span><span class="cov8" title="1">{
                return i.ShopperUuid == shoperUUIDVal &amp;&amp; i.ReportedAt.UTC().Unix() &gt;= then.UTC().Unix()
        }</span>).OrderByDescendingT(
                func(i *entity.ShopperHistory) int64 <span class="cov8" title="1">{ return i.ReportedAt.Unix() }</span>,
        ).First()
        <span class="cov8" title="1">if result == nil </span><span class="cov8" title="1">{
                return nil, NotFoundErr
        }</span>
        <span class="cov8" title="1">return result.(*entity.ShopperHistory), nil</span>
}

func (r *repo) Insert(session *entity.ShopperHistory) error <span class="cov8" title="1">{
        r.history = append(r.history, session)
        return nil
}</span>
</pre>
		
		<pre class="file" id="file4" style="display: none">package repository

import (
        "context"
        "corner_azenteno/entity"
        "fmt"
        "time"

        "github.com/pkg/errors"
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
        "go.mongodb.org/mongo-driver/mongo/readpref"
)

type mongoRepository struct {
        client   *mongo.Client
        database string
        timeout  time.Duration
}

const (
        reportedAt       = "reported_at"
        sessionUUID      = "session_uuid"
        shopperUUID      = "shopper_uuid"
        orderDesc        = -1
        greaterEqualThan = "$gte"
)

func newMongoClient(mongoHost string, mongoPort int, mongoTimeout int) (*mongo.Client, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(context.Background(), time.Duration(mongoTimeout)*time.Second)
        defer cancel()
        client, err := mongo.Connect(ctx, options.Client().ApplyURI(fmt.Sprintf("mongodb://%s:%d", mongoHost, mongoPort)))
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">err = client.Ping(ctx, readpref.Primary())
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov0" title="0">return client, nil</span>
}

func NewMongoRepository(mongoHost string, mongoPort int, mongoDB string, mongoTimeout int) SessionRepository <span class="cov0" title="0">{
        client, _ := newMongoClient(mongoHost, mongoPort, mongoTimeout)
        repo := &amp;mongoRepository{
                timeout:  time.Duration(mongoTimeout) * time.Second,
                database: mongoDB,
                client:   client,
        }
        return repo
}</span>

func (r *mongoRepository) GetSessionHistory(sessionUUIDVal string) ([]*entity.ShopperHistory, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(context.Background(), r.timeout)
        defer cancel()
        collection := r.client.Database(r.database).Collection("sessions")
        var results []*entity.ShopperHistory
        findOpts := options.Find()
        findOpts.SetSort(bson.D{primitive.E{Key: reportedAt, Value: orderDesc}})
        cur, err := collection.Find(ctx, bson.D{primitive.E{Key: sessionUUID, Value: sessionUUIDVal}}, findOpts)
        if err != nil </span><span class="cov0" title="0">{
                return results, err
        }</span>
        <span class="cov0" title="0">defer cur.Close(context.TODO())
        for cur.Next(context.TODO()) </span><span class="cov0" title="0">{
                s := &amp;entity.ShopperHistory{}
                err := cur.Decode(&amp;s)
                if err != nil </span><span class="cov0" title="0">{
                        return results, err
                }</span>
                <span class="cov0" title="0">results = append(results, s)</span>
        }
        <span class="cov0" title="0">return results, nil</span>
}

func (r *mongoRepository) GetShopperLocation(shoperUUIDVal string) (*entity.ShopperHistory, error) <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(context.Background(), r.timeout)
        defer cancel()
        collection := r.client.Database(r.database).Collection("sessions")
        now := time.Now()
        then := now.Add(-10 * time.Minute)
        findOpts := options.FindOne()
        findOpts.SetSort(bson.D{primitive.E{Key: reportedAt, Value: orderDesc}})
        result := &amp;entity.ShopperHistory{}
        err := collection.FindOne(ctx, bson.D{primitive.E{Key: shopperUUID, Value: shoperUUIDVal},
                primitive.E{Key: reportedAt, Value: bson.D{{Key: greaterEqualThan, Value: then.UTC()}}},
        }, findOpts).Decode(&amp;result)
        if err != nil </span><span class="cov0" title="0">{
                return result, err
        }</span>
        <span class="cov0" title="0">return result, nil</span>
}

func (r *mongoRepository) Insert(session *entity.ShopperHistory) error <span class="cov0" title="0">{
        ctx, cancel := context.WithTimeout(context.Background(), r.timeout)
        defer cancel()
        collection := r.client.Database(r.database).Collection("sessions")
        _, err := collection.InsertOne(
                ctx,
                session,
        )
        if err != nil </span><span class="cov0" title="0">{
                return errors.Wrap(err, "repository.Redirect.Store")
        }</span>
        <span class="cov0" title="0">return nil</span>
}
</pre>
		
		<pre class="file" id="file5" style="display: none">package service

import (
        "corner_azenteno/entity"
        "corner_azenteno/repository"

        "github.com/go-playground/validator"
)

var validate *validator.Validate

type SessionService interface {
        Validate(*entity.ShopperHistory) error
        Insert(session *entity.ShopperHistory) error
        GetSessionHistory(sessionUUID string) ([]*entity.ShopperHistory, error)
        GetShopperLocation(shopperUUID string) (*entity.ShopperHistory, error)
}

type service struct{}

var repo repository.SessionRepository

func NewSessionService(repository repository.SessionRepository) SessionService <span class="cov8" title="1">{
        repo = repository
        return &amp;service{}
}</span>

func (s *service) Validate(shopper *entity.ShopperHistory) error <span class="cov8" title="1">{
        validate = validator.New()
        return validate.Struct(shopper)
}</span>
func (s *service) Insert(session *entity.ShopperHistory) error <span class="cov8" title="1">{
        return repo.Insert(session)
}</span>
func (s *service) GetSessionHistory(sessionUUID string) ([]*entity.ShopperHistory, error) <span class="cov8" title="1">{
        return repo.GetSessionHistory(sessionUUID)
}</span>
func (s *service) GetShopperLocation(shopperUUID string) (*entity.ShopperHistory, error) <span class="cov8" title="1">{
        return repo.GetShopperLocation(shopperUUID)
}</span>
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
